<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.41">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Nathaniel Forde">

<title>Modelling Improvement as Lift across Pooled Experiments â€“ Examined Algorithms</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../">
<script src="../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting-48ffa3e5b9d089919c6712c39e5b00f2.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../site_libs/bootstrap/bootstrap-6d5f49080fd7a04518cb6db3008564bf.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="../../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../../index.html">
    <span class="navbar-title">Examined Algorithms</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../../blog.html"> 
<span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../opensource.html"> 
<span class="menu-text">Open Source Projects</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../talks.html"> 
<span class="menu-text">Talks</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../resume/Nathaniel_Forde_Resume.pdf"> 
<span class="menu-text">CV</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/NathanielF"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/forde_nathaniel"> <i class="bi bi-twitter" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
  <a href="" class="quarto-reader-toggle quarto-navigation-tool px-1" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Modelling Improvement as Lift across Pooled Experiments</h1>
                      </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Nathaniel Forde </p>
            </div>
    </div>
      
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#example-experiments-with-count-successes" id="toc-example-experiments-with-count-successes" class="nav-link active" data-scroll-target="#example-experiments-with-count-successes">Example Experiment(s) with Count Successes</a></li>
  <li><a href="#the-model" id="toc-the-model" class="nav-link" data-scroll-target="#the-model">The Model</a></li>
  <li><a href="#the-estimation-step" id="toc-the-estimation-step" class="nav-link" data-scroll-target="#the-estimation-step">The Estimation Step</a></li>
  <li><a href="#plotting-and-convergence-checks" id="toc-plotting-and-convergence-checks" class="nav-link" data-scroll-target="#plotting-and-convergence-checks">Plotting and Convergence checks</a></li>
  <li><a href="#plotting-predicted-trajectories" id="toc-plotting-predicted-trajectories" class="nav-link" data-scroll-target="#plotting-predicted-trajectories">Plotting Predicted Trajectories</a></li>
  <li><a href="#generate-new-views-with-new-experimental-data" id="toc-generate-new-views-with-new-experimental-data" class="nav-link" data-scroll-target="#generate-new-views-with-new-experimental-data">Generate new views with new Experimental data</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<div id="cell-1" class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pymc <span class="im">as</span> pm</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> bambi <span class="im">as</span> bmb</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> arviz <span class="im">as</span> az</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> bambi.plots <span class="im">import</span> plot_cap</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy <span class="im">import</span> stats</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg ansi-bold">Running cells with 'Python 3.9.6 ('blog_env')' requires ipykernel package.

Run the following command to install 'ipykernel' into the Python environment. 

Command: 'conda install -n blog_env ipykernel --update-deps --force-reinstall'</span></pre>
</div>
</div>
</div>
<p>Itâ€™s useful fact that the Lift measurement of success can be more nicely modelled under a log transform. In this analysis weâ€™ll follow the example in Demetriâ€™s blog: https://dpananos.github.io/posts/2022-07-20-pooling-experiments/ and demonstrate how we can pool information across seperate experiments. In particular weâ€™ll see why this type of modelling is apt for planning expected amount of cumulative gains over successive experiments. First observe how the Lift measurement can can be transformed to facilitate modelling.</p>
<div id="cell-3" class="cell" data-execution_count="540">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">11</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>fig, axs <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">20</span>, <span class="dv">8</span>))</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>axs <span class="op">=</span> axs.flatten()</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>counts_success_control <span class="op">=</span> np.random.normal(<span class="dv">10</span>, <span class="dv">2</span>, <span class="dv">100</span>)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>counts_success_treatment <span class="op">=</span> np.random.normal(<span class="dv">8</span>, <span class="dv">2</span>, <span class="dv">100</span>)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>].hist(counts_success_control, alpha<span class="op">=</span><span class="fl">.3</span>, label<span class="op">=</span><span class="st">'control'</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>].hist(counts_success_treatment, alpha<span class="op">=</span><span class="fl">0.2</span>, label<span class="op">=</span><span class="st">'treatment'</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>].legend()</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>].set_title(<span class="st">"Successes in Treatment and Control for 100 Experiments"</span>)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>rr <span class="op">=</span> counts_success_treatment <span class="op">/</span> counts_success_control</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>].hist(rr, alpha<span class="op">=</span><span class="fl">0.3</span>, label<span class="op">=</span><span class="st">'RR/Lift'</span>, color<span class="op">=</span><span class="st">'y'</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>].legend()</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>].set_title(<span class="st">"RR/Lift"</span>)</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">2</span>].hist(np.log(rr), label<span class="op">=</span><span class="st">'logged Lift'</span>, alpha<span class="op">=</span><span class="fl">0.4</span>, color<span class="op">=</span><span class="st">'green'</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">2</span>].set_title(<span class="st">"Logged RR/Lift"</span>)</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">3</span>].hist(np.exp(np.log(rr)), label<span class="op">=</span><span class="st">'exponentiated Logged Lift'</span>, alpha<span class="op">=</span><span class="fl">0.4</span>, color<span class="op">=</span><span class="st">'purple'</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">3</span>].set_title(<span class="st">" Exp Logged RR/Lift"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="540">
<pre><code>Text(0.5, 1.0, ' Exp Logged RR/Lift')</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="nathaniel_forde_pooling_files/figure-html/cell-3-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<section id="example-experiments-with-count-successes" class="level2">
<h2 class="anchored" data-anchor-id="example-experiments-with-count-successes">Example Experiment(s) with Count Successes</h2>
<p>The original data was modelled in the Stan probabilistic programming language. Weâ€™ll use this opportunity to translate the code into a pymc implementation.</p>
<p>In the scenario we have 12 seperate experiments with 50,000 units on either arm of the experiment. The were desigined to detect conversion in the arm of each trial. Only four of the experiments were successful in the sense that they showed a positive lift distinguishable from statistical noise under a 5% p-value threshold. Management wishes to achieve a total Lift of 2x over the next year. We want to determine how plausible that goal is given our track record so far.</p>
<div id="cell-5" class="cell" data-execution_count="60">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>df_pooling <span class="op">=</span> pd.read_csv(<span class="st">'pooling_data.csv'</span>)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>df_pooling</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="60">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Unnamed: 0</th>
<th data-quarto-table-cell-role="th">n_per_group</th>
<th data-quarto-table-cell-role="th">y_txt</th>
<th data-quarto-table-cell-role="th">y_control</th>
<th data-quarto-table-cell-role="th">estimated_relative_lift</th>
<th data-quarto-table-cell-role="th">pvals</th>
<th data-quarto-table-cell-role="th">experiment</th>
<th data-quarto-table-cell-role="th">estimated_sd_relative_lift</th>
<th data-quarto-table-cell-role="th">estimated_log_relative_lift</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>1</td>
<td>50000</td>
<td>551</td>
<td>492</td>
<td>1.119919</td>
<td>0.035510</td>
<td>1</td>
<td>0.061704</td>
<td>0.113256</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>2</td>
<td>50000</td>
<td>510</td>
<td>490</td>
<td>1.040816</td>
<td>0.272968</td>
<td>2</td>
<td>0.062941</td>
<td>0.040005</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>3</td>
<td>50000</td>
<td>548</td>
<td>509</td>
<td>1.076621</td>
<td>0.119989</td>
<td>3</td>
<td>0.061233</td>
<td>0.073827</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>4</td>
<td>50000</td>
<td>537</td>
<td>511</td>
<td>1.050881</td>
<td>0.218777</td>
<td>4</td>
<td>0.061475</td>
<td>0.049629</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>5</td>
<td>50000</td>
<td>558</td>
<td>508</td>
<td>1.098425</td>
<td>0.065669</td>
<td>5</td>
<td>0.060997</td>
<td>0.093878</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>6</td>
<td>50000</td>
<td>542</td>
<td>489</td>
<td>1.108384</td>
<td>0.051774</td>
<td>6</td>
<td>0.062048</td>
<td>0.102904</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>7</td>
<td>50000</td>
<td>533</td>
<td>495</td>
<td>1.076768</td>
<td>0.123029</td>
<td>7</td>
<td>0.062100</td>
<td>0.073964</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>8</td>
<td>50000</td>
<td>544</td>
<td>468</td>
<td>1.162393</td>
<td>0.008903</td>
<td>8</td>
<td>0.062729</td>
<td>0.150481</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>9</td>
<td>50000</td>
<td>519</td>
<td>521</td>
<td>0.996161</td>
<td>0.512433</td>
<td>9</td>
<td>0.061694</td>
<td>-0.003846</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>10</td>
<td>50000</td>
<td>532</td>
<td>469</td>
<td>1.134328</td>
<td>0.024447</td>
<td>10</td>
<td>0.063023</td>
<td>0.126041</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">10</td>
<td>11</td>
<td>50000</td>
<td>555</td>
<td>487</td>
<td>1.139630</td>
<td>0.018467</td>
<td>11</td>
<td>0.061767</td>
<td>0.130704</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">11</td>
<td>12</td>
<td>50000</td>
<td>525</td>
<td>497</td>
<td>1.056338</td>
<td>0.197962</td>
<td>12</td>
<td>0.062264</td>
<td>0.054808</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="cell-6" class="cell" data-execution_count="860">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>fig, axs <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">20</span>, <span class="dv">10</span>))</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>axs <span class="op">=</span> axs.flatten()</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>].hist(df_pooling[<span class="st">'y_control'</span>], alpha<span class="op">=</span><span class="fl">.3</span>, label<span class="op">=</span><span class="st">'control'</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>].hist(df_pooling[<span class="st">'y_txt'</span>], alpha<span class="op">=</span><span class="fl">0.2</span>, label<span class="op">=</span><span class="st">'treatment'</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>].legend()</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>].set_title(<span class="st">"Successes in Treatment and Control for 100 Experiments"</span>)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>rr <span class="op">=</span> df_pooling[<span class="st">'y_txt'</span>] <span class="op">/</span> df_pooling[<span class="st">'y_control'</span>]</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>].hist(rr, alpha<span class="op">=</span><span class="fl">0.3</span>, label<span class="op">=</span><span class="st">'RR/Lift'</span>, color<span class="op">=</span><span class="st">'y'</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>].legend()</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>].set_title(<span class="st">"RR/Lift"</span>)</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">2</span>].hist(np.log(rr), label<span class="op">=</span><span class="st">'logged Lift'</span>, alpha<span class="op">=</span><span class="fl">0.4</span>, color<span class="op">=</span><span class="st">'green'</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">2</span>].set_title(<span class="st">"Logged RR/Lift"</span>)</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">3</span>].hist(np.exp(np.log(rr)), label<span class="op">=</span><span class="st">'exponentiated Logged Lift'</span>, alpha<span class="op">=</span><span class="fl">0.4</span>, color<span class="op">=</span><span class="st">'purple'</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">3</span>].set_title(<span class="st">" Exp Logged RR/Lift"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="860">
<pre><code>Text(0.5, 1.0, ' Exp Logged RR/Lift')</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="nathaniel_forde_pooling_files/figure-html/cell-5-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="the-model" class="level2">
<h2 class="anchored" data-anchor-id="the-model">The Model</h2>
<p>We want to pool the information across our 12 experiments and to do so we model them hierarchically as a draws from an overarching normal distribution. The assumptions means we have to set priors on the shape of our parameters. We allow the hierarchical Normal distribution be configured with a centre of mass drawn from the StudentT distribution ensuring that we can have heavy tails in the distribution to account for outlier experiments with massive returns. The code and structure of the model are displayed below:</p>
<div id="cell-8" class="cell" data-execution_count="685">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pm.Model() <span class="im">as</span> model:</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>     <span class="cf">pass</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>model.add_coord(<span class="st">'exp_id'</span>, <span class="bu">list</span>(<span class="bu">range</span>(<span class="dv">12</span>)), mutable<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> model:</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    exp_id <span class="op">=</span> pm.MutableData(<span class="st">"exp"</span>, <span class="bu">list</span>(<span class="bu">range</span>(<span class="dv">12</span>)))</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Priors for the Hierarchical Log Lift Distribution</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    mu_metric <span class="op">=</span> pm.StudentT(<span class="st">'mu_metric'</span>, mu<span class="op">=</span><span class="dv">0</span>, sigma<span class="op">=</span><span class="fl">2.5</span>, nu<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    sig_ex <span class="op">=</span> pm.HalfCauchy(<span class="st">'sig_ex'</span>, <span class="fl">0.01</span>)</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Priors for the Individual effects for each experiment</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>    z_ex <span class="op">=</span> pm.Normal(<span class="st">'z_ex'</span>, <span class="dv">0</span>, <span class="dv">1</span>, dims<span class="op">=</span><span class="st">'exp_id'</span>)</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convenience wrappers for inputting fresh data</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>    est_lift_sd <span class="op">=</span> pm.MutableData(<span class="st">'est_lift_sd'</span>, df_pooling[<span class="st">'estimated_sd_relative_lift'</span>], dims<span class="op">=</span><span class="st">'exp_id'</span>)</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>    est_log_lift <span class="op">=</span> pm.MutableData(<span class="st">'est_log_lift'</span>, df_pooling[<span class="st">'estimated_log_relative_lift'</span>], dims<span class="op">=</span><span class="st">'exp_id'</span>)</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">## pooling the indivdual experiemnts, ensuring shrinkage to the overall mean</span></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>    true_log_rr <span class="op">=</span> pm.Deterministic(<span class="st">'true_log_rr'</span>, mu_metric <span class="op">+</span> z_ex[exp_id]<span class="op">*</span>sig_ex, dims<span class="op">=</span><span class="st">'exp_id'</span>)</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>    <span class="co">## Likelihood model for Logged Lift using observed values</span></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>    estimated_log_relative_lift <span class="op">=</span> pm.Normal(<span class="st">"estimated_log_relative_lift"</span>, mu<span class="op">=</span>true_log_rr[exp_id], sigma<span class="op">=</span>est_lift_sd[exp_id], </span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>                                            observed<span class="op">=</span>est_log_lift, dims<span class="op">=</span><span class="st">"exp_id"</span>)</span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>    estimated_relative_lift <span class="op">=</span> pm.Deterministic(<span class="st">'estimated_relative_lift'</span>, pm.math.exp(estimated_log_relative_lift[exp_id]), dims<span class="op">=</span><span class="st">'exp_id'</span>)</span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>    </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-9" class="cell" data-execution_count="686">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>pm.model_to_graphviz(model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="686">
<div>
<figure class="figure">
<p><img src="nathaniel_forde_pooling_files/figure-html/cell-7-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="the-estimation-step" class="level2">
<h2 class="anchored" data-anchor-id="the-estimation-step">The Estimation Step</h2>
<p>In the Bayesian workflow we sample both the priors, the prior predictive and posterior_predictive distributions. These allow us to assess model fit and the degree to which our model captures the observed data.</p>
<div id="cell-11" class="cell" data-execution_count="687">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> model:</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    idata <span class="op">=</span> pm.sample()</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    idata.extend(pm.sample_prior_predictive(samples<span class="op">=</span><span class="dv">50</span>, random_seed<span class="op">=</span><span class="dv">1</span>))</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    idata.extend(pm.sample_posterior_predictive(idata, var_names<span class="op">=</span>[<span class="st">"estimated_log_relative_lift"</span>, <span class="st">"mu_metric"</span>, <span class="st">"sig_ex"</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Auto-assigning NUTS sampler...
INFO:pymc:Auto-assigning NUTS sampler...
Initializing NUTS using jitter+adapt_diag...
INFO:pymc:Initializing NUTS using jitter+adapt_diag...
Multiprocess sampling (4 chains in 4 jobs)
INFO:pymc:Multiprocess sampling (4 chains in 4 jobs)
NUTS: [mu_metric, sig_ex, z_ex]
INFO:pymc:NUTS: [mu_metric, sig_ex, z_ex]</code></pre>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="8000" class="" max="8000" style="width:300px; height:20px; vertical-align: middle;"></progress>
      100.00% [8000/8000 00:07&lt;00:00 Sampling 4 chains, 21 divergences]
    </div>
    
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Sampling 4 chains for 1_000 tune and 1_000 draw iterations (4_000 + 4_000 draws total) took 26 seconds.
INFO:pymc:Sampling 4 chains for 1_000 tune and 1_000 draw iterations (4_000 + 4_000 draws total) took 26 seconds.
There was 1 divergence after tuning. Increase `target_accept` or reparameterize.
ERROR:pymc:There was 1 divergence after tuning. Increase `target_accept` or reparameterize.
There were 6 divergences after tuning. Increase `target_accept` or reparameterize.
ERROR:pymc:There were 6 divergences after tuning. Increase `target_accept` or reparameterize.
There were 11 divergences after tuning. Increase `target_accept` or reparameterize.
ERROR:pymc:There were 11 divergences after tuning. Increase `target_accept` or reparameterize.
There were 3 divergences after tuning. Increase `target_accept` or reparameterize.
ERROR:pymc:There were 3 divergences after tuning. Increase `target_accept` or reparameterize.</code></pre>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="4000" class="" max="4000" style="width:300px; height:20px; vertical-align: middle;"></progress>
      100.00% [4000/4000 00:01&lt;00:00]
    </div>
    
</div>
</div>
</section>
<section id="plotting-and-convergence-checks" class="level2">
<h2 class="anchored" data-anchor-id="plotting-and-convergence-checks">Plotting and Convergence checks</h2>
<div id="cell-13" class="cell" data-execution_count="626">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>az.plot_trace(idata, var_names<span class="op">=</span>[<span class="st">'mu_metric'</span>, <span class="st">'z_ex'</span>, <span class="st">'true_log_rr'</span>, <span class="st">'sig_ex'</span>], figsize<span class="op">=</span>(<span class="dv">20</span>, <span class="dv">8</span>))<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="nathaniel_forde_pooling_files/figure-html/cell-9-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-14" class="cell" data-execution_count="627">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>az.plot_ppc(idata, figsize<span class="op">=</span>(<span class="dv">20</span>, <span class="dv">7</span>), kind<span class="op">=</span><span class="st">'scatter'</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="nathaniel_forde_pooling_files/figure-html/cell-10-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-15" class="cell" data-execution_count="598">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>az.summary(idata)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/Users/nathanielforde/Documents/Gitlab/async_research_club/.venv/lib/python3.9/site-packages/arviz/stats/diagnostics.py:586: RuntimeWarning: invalid value encountered in double_scalars
  (between_chain_variance / within_chain_variance + num_samples - 1) / (num_samples)</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="598">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">mean</th>
<th data-quarto-table-cell-role="th">sd</th>
<th data-quarto-table-cell-role="th">hdi_3%</th>
<th data-quarto-table-cell-role="th">hdi_97%</th>
<th data-quarto-table-cell-role="th">mcse_mean</th>
<th data-quarto-table-cell-role="th">mcse_sd</th>
<th data-quarto-table-cell-role="th">ess_bulk</th>
<th data-quarto-table-cell-role="th">ess_tail</th>
<th data-quarto-table-cell-role="th">r_hat</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">mu_metric</td>
<td>0.083</td>
<td>0.018</td>
<td>0.050</td>
<td>0.118</td>
<td>0.000</td>
<td>0.000</td>
<td>4133.0</td>
<td>2445.0</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">z_ex[0]</td>
<td>0.041</td>
<td>0.987</td>
<td>-1.774</td>
<td>1.968</td>
<td>0.014</td>
<td>0.017</td>
<td>4873.0</td>
<td>2808.0</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">z_ex[1]</td>
<td>-0.088</td>
<td>0.995</td>
<td>-2.017</td>
<td>1.718</td>
<td>0.014</td>
<td>0.017</td>
<td>5093.0</td>
<td>2906.0</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">z_ex[2]</td>
<td>-0.037</td>
<td>0.971</td>
<td>-1.795</td>
<td>1.796</td>
<td>0.014</td>
<td>0.016</td>
<td>4757.0</td>
<td>3008.0</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">z_ex[3]</td>
<td>-0.079</td>
<td>1.011</td>
<td>-1.973</td>
<td>1.788</td>
<td>0.014</td>
<td>0.017</td>
<td>4925.0</td>
<td>2573.0</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">z_ex[4]</td>
<td>0.046</td>
<td>0.974</td>
<td>-1.860</td>
<td>1.815</td>
<td>0.013</td>
<td>0.016</td>
<td>5477.0</td>
<td>2826.0</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">z_ex[5]</td>
<td>0.041</td>
<td>0.994</td>
<td>-1.815</td>
<td>1.892</td>
<td>0.015</td>
<td>0.019</td>
<td>4581.0</td>
<td>2276.0</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">z_ex[6]</td>
<td>-0.003</td>
<td>0.965</td>
<td>-1.727</td>
<td>1.879</td>
<td>0.015</td>
<td>0.016</td>
<td>4196.0</td>
<td>2759.0</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">z_ex[7]</td>
<td>0.165</td>
<td>0.987</td>
<td>-1.713</td>
<td>1.959</td>
<td>0.015</td>
<td>0.017</td>
<td>4426.0</td>
<td>2569.0</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">z_ex[8]</td>
<td>-0.183</td>
<td>0.992</td>
<td>-2.046</td>
<td>1.649</td>
<td>0.014</td>
<td>0.016</td>
<td>4770.0</td>
<td>2848.0</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">z_ex[9]</td>
<td>0.077</td>
<td>0.998</td>
<td>-1.664</td>
<td>2.037</td>
<td>0.014</td>
<td>0.017</td>
<td>4990.0</td>
<td>2714.0</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">z_ex[10]</td>
<td>0.115</td>
<td>0.998</td>
<td>-1.752</td>
<td>1.988</td>
<td>0.014</td>
<td>0.018</td>
<td>5001.0</td>
<td>2612.0</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">z_ex[11]</td>
<td>-0.082</td>
<td>0.997</td>
<td>-1.909</td>
<td>1.840</td>
<td>0.015</td>
<td>0.018</td>
<td>4634.0</td>
<td>2564.0</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">sig_ex</td>
<td>0.010</td>
<td>0.010</td>
<td>0.000</td>
<td>0.027</td>
<td>0.000</td>
<td>0.000</td>
<td>2690.0</td>
<td>1933.0</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">true_log_rr[0]</td>
<td>0.084</td>
<td>0.021</td>
<td>0.046</td>
<td>0.126</td>
<td>0.000</td>
<td>0.000</td>
<td>4049.0</td>
<td>2457.0</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">true_log_rr[1]</td>
<td>0.082</td>
<td>0.021</td>
<td>0.042</td>
<td>0.121</td>
<td>0.000</td>
<td>0.000</td>
<td>3788.0</td>
<td>2655.0</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">true_log_rr[2]</td>
<td>0.083</td>
<td>0.022</td>
<td>0.042</td>
<td>0.123</td>
<td>0.000</td>
<td>0.000</td>
<td>4097.0</td>
<td>2861.0</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">true_log_rr[3]</td>
<td>0.082</td>
<td>0.022</td>
<td>0.040</td>
<td>0.121</td>
<td>0.000</td>
<td>0.000</td>
<td>3632.0</td>
<td>2416.0</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">true_log_rr[4]</td>
<td>0.084</td>
<td>0.021</td>
<td>0.044</td>
<td>0.123</td>
<td>0.000</td>
<td>0.000</td>
<td>4032.0</td>
<td>2419.0</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">true_log_rr[5]</td>
<td>0.084</td>
<td>0.022</td>
<td>0.042</td>
<td>0.124</td>
<td>0.000</td>
<td>0.000</td>
<td>4236.0</td>
<td>2668.0</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">true_log_rr[6]</td>
<td>0.083</td>
<td>0.021</td>
<td>0.045</td>
<td>0.123</td>
<td>0.000</td>
<td>0.000</td>
<td>3702.0</td>
<td>2731.0</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">true_log_rr[7]</td>
<td>0.086</td>
<td>0.022</td>
<td>0.043</td>
<td>0.126</td>
<td>0.000</td>
<td>0.000</td>
<td>4035.0</td>
<td>2712.0</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">true_log_rr[8]</td>
<td>0.080</td>
<td>0.022</td>
<td>0.040</td>
<td>0.121</td>
<td>0.000</td>
<td>0.000</td>
<td>3619.0</td>
<td>2592.0</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">true_log_rr[9]</td>
<td>0.085</td>
<td>0.022</td>
<td>0.042</td>
<td>0.123</td>
<td>0.000</td>
<td>0.000</td>
<td>3831.0</td>
<td>2801.0</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">true_log_rr[10]</td>
<td>0.085</td>
<td>0.022</td>
<td>0.045</td>
<td>0.124</td>
<td>0.000</td>
<td>0.000</td>
<td>3814.0</td>
<td>2450.0</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">true_log_rr[11]</td>
<td>0.082</td>
<td>0.022</td>
<td>0.043</td>
<td>0.124</td>
<td>0.000</td>
<td>0.000</td>
<td>3962.0</td>
<td>2829.0</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">estimated_relative_lift[0]</td>
<td>1.120</td>
<td>0.000</td>
<td>1.120</td>
<td>1.120</td>
<td>0.000</td>
<td>0.000</td>
<td>4000.0</td>
<td>4000.0</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">estimated_relative_lift[1]</td>
<td>1.041</td>
<td>0.000</td>
<td>1.041</td>
<td>1.041</td>
<td>0.000</td>
<td>0.000</td>
<td>4000.0</td>
<td>4000.0</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">estimated_relative_lift[2]</td>
<td>1.077</td>
<td>0.000</td>
<td>1.077</td>
<td>1.077</td>
<td>0.000</td>
<td>0.000</td>
<td>4000.0</td>
<td>4000.0</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">estimated_relative_lift[3]</td>
<td>1.051</td>
<td>0.000</td>
<td>1.051</td>
<td>1.051</td>
<td>0.000</td>
<td>0.000</td>
<td>4000.0</td>
<td>4000.0</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">estimated_relative_lift[4]</td>
<td>1.098</td>
<td>0.000</td>
<td>1.098</td>
<td>1.098</td>
<td>0.000</td>
<td>0.000</td>
<td>4000.0</td>
<td>4000.0</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">estimated_relative_lift[5]</td>
<td>1.108</td>
<td>0.000</td>
<td>1.108</td>
<td>1.108</td>
<td>0.000</td>
<td>0.000</td>
<td>4000.0</td>
<td>4000.0</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">estimated_relative_lift[6]</td>
<td>1.077</td>
<td>0.000</td>
<td>1.077</td>
<td>1.077</td>
<td>0.000</td>
<td>0.000</td>
<td>4000.0</td>
<td>4000.0</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">estimated_relative_lift[7]</td>
<td>1.162</td>
<td>0.000</td>
<td>1.162</td>
<td>1.162</td>
<td>0.000</td>
<td>0.000</td>
<td>4000.0</td>
<td>4000.0</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">estimated_relative_lift[8]</td>
<td>0.996</td>
<td>0.000</td>
<td>0.996</td>
<td>0.996</td>
<td>0.000</td>
<td>0.000</td>
<td>4000.0</td>
<td>4000.0</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">estimated_relative_lift[9]</td>
<td>1.134</td>
<td>0.000</td>
<td>1.134</td>
<td>1.134</td>
<td>0.000</td>
<td>0.000</td>
<td>4000.0</td>
<td>4000.0</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">estimated_relative_lift[10]</td>
<td>1.140</td>
<td>0.000</td>
<td>1.140</td>
<td>1.140</td>
<td>0.000</td>
<td>0.000</td>
<td>4000.0</td>
<td>4000.0</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">estimated_relative_lift[11]</td>
<td>1.056</td>
<td>0.000</td>
<td>1.056</td>
<td>1.056</td>
<td>0.000</td>
<td>0.000</td>
<td>4000.0</td>
<td>4000.0</td>
<td>NaN</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<section id="simulate-draws-from-the-posterior-and-calculate-lift" class="level4">
<h4 class="anchored" data-anchor-id="simulate-draws-from-the-posterior-and-calculate-lift">Simulate Draws from the Posterior and Calculate Lift</h4>
<p>The Stan implementation has the functionality to enable the calculation of generated quantities on the fly within a model run. We need to replicate that functionality outside of our model making use of the estimated posterior distributions on the model parameters. We calculate the effect size engendered by an observed difference in proportions of conversion across the experiments, then calculate whether the simulated was large enough that we had the power to detect it against a baseline of 1% conversion. The quantities are used to define the amount of detected lift in our posterior distribution. This in turn can be used to project the amount of cumulative lift we will see over 12 experiments.</p>
<div id="cell-17" class="cell" data-execution_count="585">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>idata.stack(sample<span class="op">=</span>[<span class="st">"chain"</span>, <span class="st">"draw"</span>], inplace<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-18" class="cell" data-execution_count="586">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>generated_quanties <span class="op">=</span> []</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">12</span>):</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>    generated_data <span class="op">=</span> pd.DataFrame({<span class="st">'mu_metric'</span>: idata[<span class="st">'posterior'</span>][<span class="st">'mu_metric'</span>].values,</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>        <span class="st">'sig_ex'</span>: idata[<span class="st">'posterior'</span>][<span class="st">'sig_ex'</span>].values</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    generated_data[<span class="st">'log_rr_over_the_year'</span>] <span class="op">=</span> generated_data.<span class="bu">apply</span>(<span class="kw">lambda</span> x: np.random.normal(x[<span class="st">'mu_metric'</span>], x[<span class="st">'sig_ex'</span>], <span class="dv">1</span>)[<span class="dv">0</span>], axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>    generated_data[<span class="st">'rr_over_the_year'</span>] <span class="op">=</span> np.exp(generated_data[<span class="st">'log_rr_over_the_year'</span>])</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">## Calculate effect size for proportions against base 0.01</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>    generated_data[<span class="st">'es'</span>] <span class="op">=</span> generated_data.<span class="bu">apply</span>(<span class="kw">lambda</span> x: <span class="dv">2</span><span class="op">*</span>np.arcsin(np.sqrt(x[<span class="st">'rr_over_the_year'</span>] <span class="op">*</span> <span class="fl">0.01</span>)) <span class="op">-</span>  <span class="dv">2</span><span class="op">*</span>np.arcsin(np.sqrt(<span class="fl">0.01</span>)), axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">## Calculate power based on difference from baseline with known sample size</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>    generated_data[<span class="st">'power'</span>] <span class="op">=</span> generated_data.<span class="bu">apply</span>(<span class="kw">lambda</span> x: <span class="dv">1</span> <span class="op">-</span> stats.norm.cdf( <span class="fl">1.644854</span> <span class="op">-</span> x[<span class="st">'es'</span>] <span class="op">*</span> np.sqrt(<span class="dv">50_000</span><span class="op">/</span><span class="dv">2</span>), <span class="dv">0</span>, <span class="dv">1</span>), axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">## Weight lift by our ability to detect given power in experiment</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>    generated_data[<span class="st">'detected_lift'</span>] <span class="op">=</span> generated_data[<span class="st">'power'</span>]<span class="op">*</span> np.log(generated_data[<span class="st">'rr_over_the_year'</span>])</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>    generated_data[<span class="st">'experiment'</span>] <span class="op">=</span> i</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>    generated_data[<span class="st">'draw'</span>] <span class="op">=</span> generated_data.index</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>    generated_quanties.append(generated_data)</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>forecast_df <span class="op">=</span> pd.concat(generated_quanties)</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>forecast_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="586">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">mu_metric</th>
<th data-quarto-table-cell-role="th">sig_ex</th>
<th data-quarto-table-cell-role="th">log_rr_over_the_year</th>
<th data-quarto-table-cell-role="th">rr_over_the_year</th>
<th data-quarto-table-cell-role="th">es</th>
<th data-quarto-table-cell-role="th">power</th>
<th data-quarto-table-cell-role="th">detected_lift</th>
<th data-quarto-table-cell-role="th">experiment</th>
<th data-quarto-table-cell-role="th">draw</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>0.053614</td>
<td>0.003751</td>
<td>0.054232</td>
<td>1.055729</td>
<td>0.005526</td>
<td>0.220312</td>
<td>0.011948</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>0.089769</td>
<td>0.006848</td>
<td>0.078595</td>
<td>1.081766</td>
<td>0.008058</td>
<td>0.355404</td>
<td>0.027933</td>
<td>0</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>0.082105</td>
<td>0.008848</td>
<td>0.075538</td>
<td>1.078464</td>
<td>0.007739</td>
<td>0.336777</td>
<td>0.025440</td>
<td>0</td>
<td>2</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>0.076757</td>
<td>0.031000</td>
<td>0.098424</td>
<td>1.103431</td>
<td>0.010142</td>
<td>0.483548</td>
<td>0.047593</td>
<td>0</td>
<td>3</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>0.076757</td>
<td>0.031000</td>
<td>0.081759</td>
<td>1.085194</td>
<td>0.008389</td>
<td>0.375086</td>
<td>0.030667</td>
<td>0</td>
<td>4</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">3995</td>
<td>0.102766</td>
<td>0.012876</td>
<td>0.118111</td>
<td>1.125369</td>
<td>0.012232</td>
<td>0.613782</td>
<td>0.072494</td>
<td>11</td>
<td>3995</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3996</td>
<td>0.066032</td>
<td>0.000387</td>
<td>0.065700</td>
<td>1.067907</td>
<td>0.006714</td>
<td>0.279849</td>
<td>0.018386</td>
<td>11</td>
<td>3996</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">3997</td>
<td>0.062600</td>
<td>0.007694</td>
<td>0.067979</td>
<td>1.070343</td>
<td>0.006951</td>
<td>0.292589</td>
<td>0.019890</td>
<td>11</td>
<td>3997</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3998</td>
<td>0.090900</td>
<td>0.005162</td>
<td>0.103968</td>
<td>1.109565</td>
<td>0.010729</td>
<td>0.520525</td>
<td>0.054118</td>
<td>11</td>
<td>3998</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">3999</td>
<td>0.064391</td>
<td>0.010588</td>
<td>0.065984</td>
<td>1.068209</td>
<td>0.006743</td>
<td>0.281419</td>
<td>0.018569</td>
<td>11</td>
<td>3999</td>
</tr>
</tbody>
</table>

<p>48000 rows Ã— 9 columns</p>
</div>
</div>
</div>
</section>
<section id="generate-cumulative-lift-curves-for-n-experiments" class="level4">
<h4 class="anchored" data-anchor-id="generate-cumulative-lift-curves-for-n-experiments">Generate Cumulative Lift Curves for N-Experiments</h4>
<p>We can now line up the draws for each of our experiments and calculate the cumulative lift by taking the cumulative sum and then exponentiating to return us to the raw Lift scale.</p>
<div id="cell-20" class="cell" data-execution_count="569">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>draws_per_experiment <span class="op">=</span> forecast_df.pivot(<span class="st">'experiment'</span>, <span class="st">'draw'</span>, <span class="st">'detected_lift'</span>)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="co">## Probability of Independent events sum on the log scale</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>draws_per_experiment <span class="op">=</span> np.exp(draws_per_experiment.cumsum()).T</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>draws_per_experiment</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="569">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">experiment</th>
<th data-quarto-table-cell-role="th">0</th>
<th data-quarto-table-cell-role="th">1</th>
<th data-quarto-table-cell-role="th">2</th>
<th data-quarto-table-cell-role="th">3</th>
<th data-quarto-table-cell-role="th">4</th>
<th data-quarto-table-cell-role="th">5</th>
<th data-quarto-table-cell-role="th">6</th>
<th data-quarto-table-cell-role="th">7</th>
<th data-quarto-table-cell-role="th">8</th>
<th data-quarto-table-cell-role="th">9</th>
<th data-quarto-table-cell-role="th">10</th>
<th data-quarto-table-cell-role="th">11</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">draw</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>1.108264</td>
<td>1.184080</td>
<td>1.270116</td>
<td>1.344759</td>
<td>1.382252</td>
<td>1.493910</td>
<td>1.574159</td>
<td>1.636984</td>
<td>1.770258</td>
<td>1.896812</td>
<td>2.051490</td>
<td>2.125217</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>1.111839</td>
<td>1.173511</td>
<td>1.255733</td>
<td>1.316744</td>
<td>1.336851</td>
<td>1.431039</td>
<td>1.513762</td>
<td>1.624544</td>
<td>1.733171</td>
<td>1.984078</td>
<td>2.259019</td>
<td>2.370773</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>1.019156</td>
<td>1.058173</td>
<td>1.080910</td>
<td>1.120521</td>
<td>1.163374</td>
<td>1.190512</td>
<td>1.231332</td>
<td>1.257548</td>
<td>1.287433</td>
<td>1.320996</td>
<td>1.347873</td>
<td>1.399662</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>1.027886</td>
<td>1.062590</td>
<td>1.088567</td>
<td>1.124628</td>
<td>1.149337</td>
<td>1.189305</td>
<td>1.218267</td>
<td>1.258150</td>
<td>1.290688</td>
<td>1.328989</td>
<td>1.368187</td>
<td>1.412470</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>1.022567</td>
<td>1.037980</td>
<td>1.046979</td>
<td>1.064810</td>
<td>1.079649</td>
<td>1.086973</td>
<td>1.094045</td>
<td>1.097738</td>
<td>1.104774</td>
<td>1.108017</td>
<td>1.125943</td>
<td>1.132601</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">3995</td>
<td>1.022991</td>
<td>1.064212</td>
<td>1.091823</td>
<td>1.118289</td>
<td>1.166716</td>
<td>1.182341</td>
<td>1.208105</td>
<td>1.252252</td>
<td>1.310564</td>
<td>1.319768</td>
<td>1.351317</td>
<td>1.375962</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3996</td>
<td>1.039176</td>
<td>1.084013</td>
<td>1.129208</td>
<td>1.178795</td>
<td>1.230675</td>
<td>1.283502</td>
<td>1.337933</td>
<td>1.395778</td>
<td>1.451701</td>
<td>1.512018</td>
<td>1.576763</td>
<td>1.643312</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">3997</td>
<td>1.022346</td>
<td>1.057272</td>
<td>1.118954</td>
<td>1.183094</td>
<td>1.205393</td>
<td>1.225715</td>
<td>1.343847</td>
<td>1.407721</td>
<td>1.506250</td>
<td>1.565272</td>
<td>1.670593</td>
<td>1.755775</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3998</td>
<td>1.037186</td>
<td>1.077082</td>
<td>1.122035</td>
<td>1.166914</td>
<td>1.206876</td>
<td>1.252481</td>
<td>1.300103</td>
<td>1.352597</td>
<td>1.397989</td>
<td>1.453273</td>
<td>1.510253</td>
<td>1.565866</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">3999</td>
<td>1.026173</td>
<td>1.057943</td>
<td>1.072373</td>
<td>1.120320</td>
<td>1.155082</td>
<td>1.198584</td>
<td>1.220144</td>
<td>1.246629</td>
<td>1.275155</td>
<td>1.311698</td>
<td>1.351460</td>
<td>1.378449</td>
</tr>
</tbody>
</table>

<p>4000 rows Ã— 12 columns</p>
</div>
</div>
</div>
</section>
</section>
<section id="plotting-predicted-trajectories" class="level2">
<h2 class="anchored" data-anchor-id="plotting-predicted-trajectories">Plotting Predicted Trajectories</h2>
<p>Note how there are cumulative lift curves that go up and down due to the possibility of failed experiments. We plot here a a sample of 100 possible curves along with the key quantiles.</p>
<div id="cell-22" class="cell" data-execution_count="570">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">20</span>, <span class="dv">10</span>))</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>ax.plot(draws_per_experiment.sample(<span class="dv">100</span>).T, color<span class="op">=</span><span class="st">'grey'</span>, alpha<span class="op">=</span><span class="fl">0.2</span>)<span class="op">;</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>ax.plot(draws_per_experiment.mean(), color<span class="op">=</span><span class="st">'slateblue'</span>, label<span class="op">=</span><span class="st">'Expected'</span>, linewidth<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>ax.plot(draws_per_experiment.quantile(<span class="fl">0.75</span>), color<span class="op">=</span><span class="st">'slateblue'</span>, label<span class="op">=</span><span class="st">'p75'</span>, alpha<span class="op">=</span><span class="fl">0.5</span>, linewidth<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>ax.plot(draws_per_experiment.quantile(<span class="fl">0.25</span>), color<span class="op">=</span><span class="st">'slateblue'</span>, label<span class="op">=</span><span class="st">'p25'</span>, alpha<span class="op">=</span><span class="fl">0.5</span>, linewidth<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>ax.plot(draws_per_experiment.quantile(<span class="fl">0.99</span>), color<span class="op">=</span><span class="st">'slateblue'</span>, label<span class="op">=</span><span class="st">'p99'</span>, alpha<span class="op">=</span><span class="fl">0.5</span>, linewidth<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"Credible Cumulative Lift Curves"</span>, fontsize<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">"Lift"</span>)</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"Number of Experiments"</span>)</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>ax.legend()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="nathaniel_forde_pooling_files/figure-html/cell-15-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>We can now also ask how credible a target lift of 2x over the course of 12 experiments really is?</p>
<div id="cell-24" class="cell" data-execution_count="571">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">20</span>, <span class="dv">6</span>))</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>N, bins, patches <span class="op">=</span> ax.hist(draws_per_experiment[<span class="dv">11</span>], color<span class="op">=</span><span class="st">'slateblue'</span>, edgecolor<span class="op">=</span><span class="st">'grey'</span>, alpha<span class="op">=</span><span class="fl">0.3</span>, bins<span class="op">=</span><span class="dv">30</span>)<span class="op">;</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>ax.axvline(<span class="dv">2</span>)</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">9</span>, <span class="bu">len</span>(patches)):</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>    patches[i].set_facecolor(<span class="st">'red'</span>)</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"Proportion of Credible Curves which achieve a cumulative Lift more than 2"</span>, fontsize<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"Lift"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="571">
<pre><code>Text(0.5, 0, 'Lift')</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="nathaniel_forde_pooling_files/figure-html/cell-16-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="generate-new-views-with-new-experimental-data" class="level2">
<h2 class="anchored" data-anchor-id="generate-new-views-with-new-experimental-data">Generate new views with new Experimental data</h2>
<p>We can make use of PYMCâ€™s mutable data input to feed in new experimental data and try and predict implied effects using the posterior predictive distribution. We will continue to assume that we have 50,000 observations per experiment on each arm. But now letâ€™s assume we have 20 experiments, with a similar pattern of Lift observed on each of the experiments.</p>
<div id="cell-27" class="cell" data-execution_count="981">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>N <span class="op">=</span> <span class="dv">20</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>control <span class="op">=</span> np.random.gumbel(<span class="fl">2.2</span>, <span class="fl">0.07</span>, N)</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>treatment <span class="op">=</span> np.random.gumbel(<span class="fl">2.0</span>, <span class="fl">0.05</span>, N)</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>sd <span class="op">=</span> np.random.normal(<span class="fl">0.1</span>, <span class="fl">0.01</span>, N)</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>fig, axs <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">20</span>, <span class="dv">8</span>))</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>axs <span class="op">=</span> axs.flatten()</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>].hist(control, alpha<span class="op">=</span><span class="fl">.3</span>, label<span class="op">=</span><span class="st">'control'</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>].hist(treatment, alpha<span class="op">=</span><span class="fl">0.2</span>, label<span class="op">=</span><span class="st">'treatment'</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>].legend()</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>].set_title(<span class="st">"Successes in Treatment and Control for 100 Experiments"</span>)</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>rr <span class="op">=</span> treatment <span class="op">/</span> control</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>log_rr <span class="op">=</span> np.log(rr)</span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>].hist(rr, alpha<span class="op">=</span><span class="fl">0.3</span>, label<span class="op">=</span><span class="st">'RR/Lift'</span>, color<span class="op">=</span><span class="st">'y'</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>].legend()</span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>].set_title(<span class="st">"RR/Lift"</span>)</span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">2</span>].hist(log_rr, label<span class="op">=</span><span class="st">'logged Lift'</span>, alpha<span class="op">=</span><span class="fl">0.4</span>, color<span class="op">=</span><span class="st">'green'</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">2</span>].set_title(<span class="st">"Logged RR/Lift"</span>)</span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">3</span>].hist(np.exp(log_rr), label<span class="op">=</span><span class="st">'exponentiated Logged Lift'</span>, alpha<span class="op">=</span><span class="fl">0.4</span>, color<span class="op">=</span><span class="st">'purple'</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">3</span>].set_title(<span class="st">" Exp Logged RR/Lift"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="981">
<pre><code>Text(0.5, 1.0, ' Exp Logged RR/Lift')</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="nathaniel_forde_pooling_files/figure-html/cell-17-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Here we can pass in the new data to our old model and re-generate the posterior predictive distribution.</p>
<div id="cell-29" class="cell" data-execution_count="982">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Do the posterior predictions</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>coords <span class="op">=</span> {<span class="st">'exp_id'</span>: <span class="bu">list</span>(<span class="bu">range</span>(N))}</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> model:</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>    pm.set_data({<span class="st">"est_log_lift"</span>: log_rr, <span class="st">'exp'</span>:<span class="bu">list</span>(<span class="bu">range</span>(N)), <span class="st">'est_lift_sd'</span>: sd}, coords<span class="op">=</span>coords)</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>    ppc <span class="op">=</span> pm.sample_posterior_predictive(idata, var_names<span class="op">=</span>[<span class="st">"estimated_log_relative_lift"</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="4000" class="" max="4000" style="width:300px; height:20px; vertical-align: middle;"></progress>
      100.00% [4000/4000 00:00&lt;00:00]
    </div>
    
</div>
</div>
<div id="cell-30" class="cell" data-execution_count="983">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>az.plot_ppc(ppc, figsize<span class="op">=</span>(<span class="dv">20</span>, <span class="dv">10</span>), kind<span class="op">=</span><span class="st">'scatter'</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="nathaniel_forde_pooling_files/figure-html/cell-19-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-31" class="cell" data-execution_count="984">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>ppc.stack(sample<span class="op">=</span>[<span class="st">"chain"</span>, <span class="st">"draw"</span>], inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>predicted <span class="op">=</span> ppc[<span class="st">'posterior_predictive'</span>][<span class="st">'estimated_log_relative_lift'</span>].to_dataframe().reset_index()</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>predicted</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="984">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">exp_id</th>
<th data-quarto-table-cell-role="th">chain</th>
<th data-quarto-table-cell-role="th">draw</th>
<th data-quarto-table-cell-role="th">estimated_log_relative_lift</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.129563</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0.160167</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>0</td>
<td>0</td>
<td>2</td>
<td>0.015636</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>0</td>
<td>0</td>
<td>3</td>
<td>0.131316</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>0</td>
<td>0</td>
<td>4</td>
<td>0.155715</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">79995</td>
<td>19</td>
<td>3</td>
<td>995</td>
<td>0.047107</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">79996</td>
<td>19</td>
<td>3</td>
<td>996</td>
<td>0.152401</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">79997</td>
<td>19</td>
<td>3</td>
<td>997</td>
<td>0.257834</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">79998</td>
<td>19</td>
<td>3</td>
<td>998</td>
<td>0.037314</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">79999</td>
<td>19</td>
<td>3</td>
<td>999</td>
<td>-0.037456</td>
</tr>
</tbody>
</table>

<p>80000 rows Ã— 4 columns</p>
</div>
</div>
</div>
<div id="cell-32" class="cell" data-execution_count="985">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>predicted[<span class="st">'rr_over_the_year'</span>] <span class="op">=</span> np.exp(predicted[<span class="st">'estimated_log_relative_lift'</span>])</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">## Calculate effect size for proportions against base 0.01</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>predicted[<span class="st">'es'</span>] <span class="op">=</span> predicted.<span class="bu">apply</span>(<span class="kw">lambda</span> x: <span class="dv">2</span><span class="op">*</span>np.arcsin(np.sqrt(x[<span class="st">'rr_over_the_year'</span>] <span class="op">*</span> <span class="fl">0.01</span>)) <span class="op">-</span>  <span class="dv">2</span><span class="op">*</span>np.arcsin(np.sqrt(<span class="fl">0.01</span>)), axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">## Calculate power based on difference from baseline with known sample size</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>predicted[<span class="st">'power'</span>] <span class="op">=</span> predicted.<span class="bu">apply</span>(<span class="kw">lambda</span> x: <span class="dv">1</span> <span class="op">-</span> stats.norm.cdf( <span class="fl">1.644854</span> <span class="op">-</span> x[<span class="st">'es'</span>] <span class="op">*</span> np.sqrt(<span class="dv">50_000</span><span class="op">/</span><span class="dv">2</span>), <span class="dv">0</span>, <span class="dv">1</span>), axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">## Weight lift by our ability to detect given power in experiment</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>predicted[<span class="st">'detected_lift'</span>] <span class="op">=</span> predicted[<span class="st">'power'</span>]<span class="op">*</span> np.log(predicted[<span class="st">'rr_over_the_year'</span>])</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>predicted</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="985">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">exp_id</th>
<th data-quarto-table-cell-role="th">chain</th>
<th data-quarto-table-cell-role="th">draw</th>
<th data-quarto-table-cell-role="th">estimated_log_relative_lift</th>
<th data-quarto-table-cell-role="th">rr_over_the_year</th>
<th data-quarto-table-cell-role="th">es</th>
<th data-quarto-table-cell-role="th">power</th>
<th data-quarto-table-cell-role="th">detected_lift</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.129563</td>
<td>1.138330</td>
<td>0.013457</td>
<td>0.685424</td>
<td>0.088805</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0.160167</td>
<td>1.173706</td>
<td>0.016767</td>
<td>0.842840</td>
<td>0.134995</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>0</td>
<td>0</td>
<td>2</td>
<td>0.015636</td>
<td>1.015759</td>
<td>0.001578</td>
<td>0.081447</td>
<td>0.001273</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>0</td>
<td>0</td>
<td>3</td>
<td>0.131316</td>
<td>1.140329</td>
<td>0.013646</td>
<td>0.695916</td>
<td>0.091385</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>0</td>
<td>0</td>
<td>4</td>
<td>0.155715</td>
<td>1.168493</td>
<td>0.016282</td>
<td>0.823705</td>
<td>0.128263</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">79995</td>
<td>19</td>
<td>3</td>
<td>995</td>
<td>0.047107</td>
<td>1.048235</td>
<td>0.004791</td>
<td>0.187461</td>
<td>0.008831</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">79996</td>
<td>19</td>
<td>3</td>
<td>996</td>
<td>0.152401</td>
<td>1.164627</td>
<td>0.015922</td>
<td>0.808573</td>
<td>0.123227</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">79997</td>
<td>19</td>
<td>3</td>
<td>997</td>
<td>0.257834</td>
<td>1.294124</td>
<td>0.027678</td>
<td>0.996847</td>
<td>0.257021</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">79998</td>
<td>19</td>
<td>3</td>
<td>998</td>
<td>0.037314</td>
<td>1.038019</td>
<td>0.003786</td>
<td>0.147719</td>
<td>0.005512</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">79999</td>
<td>19</td>
<td>3</td>
<td>999</td>
<td>-0.037456</td>
<td>0.963237</td>
<td>-0.003729</td>
<td>0.012726</td>
<td>-0.000477</td>
</tr>
</tbody>
</table>

<p>80000 rows Ã— 8 columns</p>
</div>
</div>
</div>
<div id="cell-33" class="cell" data-execution_count="986">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>predicted_curves  <span class="op">=</span> predicted.pivot([<span class="st">'chain'</span>, <span class="st">'draw'</span>], <span class="st">'exp_id'</span>, <span class="st">'detected_lift'</span>)</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>predicted_curves</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="986">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">exp_id</th>
<th data-quarto-table-cell-role="th">0</th>
<th data-quarto-table-cell-role="th">1</th>
<th data-quarto-table-cell-role="th">2</th>
<th data-quarto-table-cell-role="th">3</th>
<th data-quarto-table-cell-role="th">4</th>
<th data-quarto-table-cell-role="th">5</th>
<th data-quarto-table-cell-role="th">6</th>
<th data-quarto-table-cell-role="th">7</th>
<th data-quarto-table-cell-role="th">8</th>
<th data-quarto-table-cell-role="th">9</th>
<th data-quarto-table-cell-role="th">10</th>
<th data-quarto-table-cell-role="th">11</th>
<th data-quarto-table-cell-role="th">12</th>
<th data-quarto-table-cell-role="th">13</th>
<th data-quarto-table-cell-role="th">14</th>
<th data-quarto-table-cell-role="th">15</th>
<th data-quarto-table-cell-role="th">16</th>
<th data-quarto-table-cell-role="th">17</th>
<th data-quarto-table-cell-role="th">18</th>
<th data-quarto-table-cell-role="th">19</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">chain</th>
<th data-quarto-table-cell-role="th">draw</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td rowspan="5" data-quarto-table-cell-role="th" data-valign="top">0</td>
<td data-quarto-table-cell-role="th">0</td>
<td>0.088805</td>
<td>0.001197</td>
<td>-0.000484</td>
<td>0.171321</td>
<td>0.307768</td>
<td>-0.000114</td>
<td>-0.000358</td>
<td>-0.000050</td>
<td>0.119042</td>
<td>0.035483</td>
<td>0.008818</td>
<td>0.017530</td>
<td>0.126463</td>
<td>0.044351</td>
<td>0.021847</td>
<td>0.077193</td>
<td>0.055479</td>
<td>8.898377e-03</td>
<td>0.010240</td>
<td>0.001336</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>0.134995</td>
<td>-0.000085</td>
<td>0.169952</td>
<td>-0.000517</td>
<td>0.005521</td>
<td>0.006376</td>
<td>-0.000489</td>
<td>0.134169</td>
<td>0.245929</td>
<td>0.038492</td>
<td>-0.000515</td>
<td>0.002976</td>
<td>0.209037</td>
<td>0.062656</td>
<td>0.002869</td>
<td>0.139614</td>
<td>0.254202</td>
<td>4.575356e-02</td>
<td>0.286258</td>
<td>0.206261</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>0.001273</td>
<td>0.191886</td>
<td>0.001264</td>
<td>0.090177</td>
<td>-0.000060</td>
<td>0.330653</td>
<td>0.202727</td>
<td>-0.000368</td>
<td>0.015053</td>
<td>0.305181</td>
<td>-0.000259</td>
<td>0.049178</td>
<td>-0.000262</td>
<td>0.015266</td>
<td>0.090864</td>
<td>0.060138</td>
<td>0.008056</td>
<td>1.787840e-01</td>
<td>0.003004</td>
<td>-0.000283</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>0.091385</td>
<td>-0.000165</td>
<td>0.175993</td>
<td>0.210623</td>
<td>-0.000398</td>
<td>0.000092</td>
<td>0.008886</td>
<td>0.169622</td>
<td>0.016613</td>
<td>-0.000175</td>
<td>-0.000333</td>
<td>-0.000151</td>
<td>0.069115</td>
<td>0.003197</td>
<td>0.009931</td>
<td>0.008144</td>
<td>0.069742</td>
<td>5.125832e-04</td>
<td>0.223892</td>
<td>-0.000056</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>0.128263</td>
<td>-0.000264</td>
<td>0.029506</td>
<td>0.074044</td>
<td>-0.000028</td>
<td>0.013448</td>
<td>0.034857</td>
<td>0.181062</td>
<td>0.059433</td>
<td>0.119991</td>
<td>0.022186</td>
<td>0.181830</td>
<td>0.078825</td>
<td>0.042061</td>
<td>0.229243</td>
<td>0.173755</td>
<td>0.131305</td>
<td>-3.022104e-08</td>
<td>0.019529</td>
<td>0.023409</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td rowspan="5" data-quarto-table-cell-role="th" data-valign="top">3</td>
<td data-quarto-table-cell-role="th">995</td>
<td>0.010141</td>
<td>0.046869</td>
<td>0.261628</td>
<td>0.187072</td>
<td>0.207434</td>
<td>0.041217</td>
<td>0.029719</td>
<td>0.098765</td>
<td>-0.000002</td>
<td>0.050363</td>
<td>-0.000449</td>
<td>0.215972</td>
<td>0.084759</td>
<td>0.035756</td>
<td>0.187955</td>
<td>0.000416</td>
<td>0.005068</td>
<td>-3.511800e-04</td>
<td>0.208030</td>
<td>0.008831</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">996</td>
<td>0.020431</td>
<td>0.113550</td>
<td>-0.000424</td>
<td>0.009520</td>
<td>0.283799</td>
<td>0.010694</td>
<td>-0.000157</td>
<td>0.030434</td>
<td>0.104618</td>
<td>0.032070</td>
<td>0.117800</td>
<td>0.152587</td>
<td>-0.000257</td>
<td>-0.000003</td>
<td>-0.000008</td>
<td>0.029872</td>
<td>0.224894</td>
<td>2.599086e-01</td>
<td>0.092621</td>
<td>0.123227</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">997</td>
<td>0.082644</td>
<td>0.004597</td>
<td>0.028806</td>
<td>0.001567</td>
<td>0.009130</td>
<td>0.000728</td>
<td>0.010956</td>
<td>0.001111</td>
<td>0.212021</td>
<td>0.240963</td>
<td>0.067241</td>
<td>0.182531</td>
<td>0.301767</td>
<td>0.221201</td>
<td>0.000654</td>
<td>0.001957</td>
<td>0.137934</td>
<td>2.372076e-01</td>
<td>0.014318</td>
<td>0.257021</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">998</td>
<td>-0.000116</td>
<td>0.085200</td>
<td>-0.000517</td>
<td>0.005099</td>
<td>0.029492</td>
<td>0.040047</td>
<td>-0.000026</td>
<td>0.002956</td>
<td>0.104428</td>
<td>0.082584</td>
<td>0.000486</td>
<td>0.001877</td>
<td>0.032360</td>
<td>0.001402</td>
<td>0.003078</td>
<td>0.001904</td>
<td>-0.000390</td>
<td>-1.231683e-04</td>
<td>-0.000350</td>
<td>0.005512</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">999</td>
<td>0.002641</td>
<td>0.138605</td>
<td>0.201605</td>
<td>0.103506</td>
<td>0.180542</td>
<td>0.034928</td>
<td>0.012054</td>
<td>-0.000369</td>
<td>0.047570</td>
<td>0.086689</td>
<td>0.257165</td>
<td>0.102930</td>
<td>0.221825</td>
<td>0.178257</td>
<td>0.010981</td>
<td>0.324702</td>
<td>0.091735</td>
<td>2.999001e-02</td>
<td>0.200721</td>
<td>-0.000477</td>
</tr>
</tbody>
</table>

<p>4000 rows Ã— 20 columns</p>
</div>
</div>
</div>
<div id="cell-34" class="cell" data-execution_count="987">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>fig, axs <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">20</span>, <span class="dv">6</span>))</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">19</span>)</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>axs <span class="op">=</span> axs.flatten()</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>N, bins, patches <span class="op">=</span> axs[<span class="dv">0</span>].hist(np.exp(predicted_curves.cumsum(axis<span class="op">=</span><span class="dv">1</span>))[<span class="dv">11</span>], color<span class="op">=</span><span class="st">'slateblue'</span>, edgecolor<span class="op">=</span><span class="st">'grey'</span>, alpha<span class="op">=</span><span class="fl">0.3</span>, bins<span class="op">=</span><span class="dv">40</span>)<span class="op">;</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>].axvline(<span class="dv">2</span>)</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="bu">len</span>(patches)):</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>    patches[i].set_facecolor(<span class="st">'red'</span>)</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"Proportion of Credible Curves which achieve a cumulative Lift more than 2"</span>, fontsize<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"Lift"</span>)</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>].set_title(<span class="st">"Proportion of Curves which achieve 2x Lift after 20 experiments"</span>)</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>].legend()</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>].plot(np.exp(predicted_curves.cumsum(axis<span class="op">=</span><span class="dv">1</span>)).sample(<span class="dv">100</span>).T, color<span class="op">=</span><span class="st">'grey'</span>)<span class="op">;</span></span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>].plot(np.exp(predicted_curves.cumsum(axis<span class="op">=</span><span class="dv">1</span>)).mean(), color<span class="op">=</span><span class="st">'red'</span>, label<span class="op">=</span><span class="st">'Expected Growth curve'</span>)<span class="op">;</span></span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>].set_title(<span class="st">"Sample Set of Possible Growth Curves"</span>)</span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>].set_ylim(<span class="dv">0</span>, <span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>WARNING:matplotlib.legend:No artists with labels found to put in legend.  Note that artists whose label start with an underscore are ignored when legend() is called with no argument.</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="nathaniel_forde_pooling_files/figure-html/cell-23-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "î§‹";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>